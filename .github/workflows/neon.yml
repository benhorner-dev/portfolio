name: Manage Preview Branch for Pull Request
on:
  deployment_status:
  pull_request:
    types:
      - closed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
jobs:
  setup:
    name: Setup
    outputs:
      branch: ${{ steps.extract_info.outputs.branch }}
      pr_number: ${{ steps.extract_info.outputs.pr_number }}
      neon_branch_name: ${{ steps.extract_info.outputs.neon_branch_name }}
    runs-on: ubuntu-latest
    steps:
      - name: Debug Deployment Event
        if: github.event_name == 'deployment_status'
        run: |
          echo "ðŸ” Full deployment event payload:"
          echo '${{ toJson(github.event) }}'

      - name: Extract PR and Branch Info
        id: extract_info
        run: |
          echo "ðŸ” Event name: ${{ github.event_name }}"

          if [[ "${{ github.event_name }}" == "deployment_status" ]]; then
            # For deployment_status events, we need to get branch info from the deployment
            DEPLOYMENT_REF="${{ github.event.deployment.ref }}"
            DEPLOYMENT_ENV="${{ github.event.deployment.environment }}"
            echo "ðŸ” Deployment ref: $DEPLOYMENT_REF"
            echo "ðŸ” Deployment environment: $DEPLOYMENT_ENV"

            # Check if deployment has payload with branch info
            DEPLOYMENT_PAYLOAD='${{ toJson(github.event.deployment.payload) }}'
            echo "ðŸ” Deployment payload: $DEPLOYMENT_PAYLOAD"

            # Try to extract branch name from deployment description or payload
            DEPLOYMENT_DESC="${{ github.event.deployment.description }}"
            echo "ðŸ” Deployment description: $DEPLOYMENT_DESC"

            # Method 1: Try to get branch from GitHub API using the commit SHA
            COMMIT_SHA="$DEPLOYMENT_REF"
            echo "ðŸ” Fetching branch info for commit: $COMMIT_SHA"

            # Get branches that contain this commit
            BRANCHES_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/commits/$COMMIT_SHA/branches-where-head")

            echo "ðŸ” Branches containing this commit:"
            echo "$BRANCHES_RESPONSE" | jq -r '.[].name' || echo "No branches found or jq failed"

            # Try to find a branch that looks like a feature branch (not main/master)
            BRANCH_NAME=$(echo "$BRANCHES_RESPONSE" | jq -r '.[] | select(.name != "main" and .name != "master") | .name' | head -n 1)

            if [[ -z "$BRANCH_NAME" || "$BRANCH_NAME" == "null" ]]; then
              # Fallback: try to extract from deployment description or environment
              if [[ "$DEPLOYMENT_DESC" =~ ([a-zA-Z0-9/_-]+) ]]; then
                BRANCH_NAME="${BASH_REMATCH[1]}"
                echo "ðŸ” Extracted branch from description: $BRANCH_NAME"
              else
                echo "âŒ Could not determine branch name"
                exit 1
              fi
            else
              echo "âœ… Found branch name: $BRANCH_NAME"
            fi

            # Try to extract PR number from branch name or find associated PR
            if [[ "$BRANCH_NAME" =~ pr-([0-9]+) ]] || [[ "$BRANCH_NAME" =~ ([0-9]+) ]]; then
              PR_NUMBER="${BASH_REMATCH[1]}"
              echo "âœ… Extracted PR number from branch name: $PR_NUMBER"
            else
              # Try to find PR for this branch
              PR_RESPONSE=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:$BRANCH_NAME&state=open")

              PR_NUMBER=$(echo "$PR_RESPONSE" | jq -r '.[0].number // empty')

              if [[ -n "$PR_NUMBER" && "$PR_NUMBER" != "null" ]]; then
                echo "âœ… Found PR number from API: $PR_NUMBER"
              else
                echo "âš ï¸ Could not find PR number, using 'unknown'"
                PR_NUMBER="unknown"
              fi
            fi

            # Construct Neon branch name
            NEON_BRANCH_NAME="preview/$BRANCH_NAME"

          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            # For pull_request events
            PR_NUMBER="${{ github.event.number }}"
            BRANCH_NAME="${{ github.head_ref }}"
            NEON_BRANCH_NAME="preview/$BRANCH_NAME"
            echo "âœ… Using PR event data - PR: $PR_NUMBER, Branch: $BRANCH_NAME"
          else
            echo "âŒ Unsupported event type: ${{ github.event_name }}"
            exit 1
          fi

          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "branch=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "neon_branch_name=$NEON_BRANCH_NAME" >> $GITHUB_OUTPUT

          echo "ðŸ” Final values:"
          echo "  PR Number: $PR_NUMBER"
          echo "  Branch: $BRANCH_NAME"
          echo "  Neon Branch Name: $NEON_BRANCH_NAME"

  migrate_preview_branch:
    name: Run Migrations on Preview Branch
    runs-on: ubuntu-latest
    needs: setup
    if: |
      github.event_name == 'deployment_status' &&
      github.event.deployment_status.state == 'success' &&
      github.event.deployment.environment == 'Preview'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Get Neon Branch Connection String
        id: get_neon_branch
        run: |
          NEON_BRANCH_NAME="${{ needs.setup.outputs.neon_branch_name }}"
          echo "ðŸ” Debug info:"
          echo "  PR Number: ${{ needs.setup.outputs.pr_number }}"
          echo "  Branch: ${{ needs.setup.outputs.branch }}"
          echo "  Looking for Neon branch: $NEON_BRANCH_NAME"

          # Get branch info from Neon API
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.NEON_API_KEY }}" \
            "https://console.neon.tech/api/v2/projects/${{ vars.NEON_PROJECT_ID }}/branches")

          # Debug: Show available branches
          echo "ðŸ” Available branches:"
          echo "$RESPONSE" | jq -r '.branches[].name'

          # Extract the database URL for our branch
          DB_URL=$(echo "$RESPONSE" | jq -r --arg branch_name "$NEON_BRANCH_NAME" \
            '.branches[] | select(.name == $branch_name) | .connection_uris[0].connection_uri')

          if [ "$DB_URL" = "null" ] || [ -z "$DB_URL" ]; then
            echo "âŒ Branch $NEON_BRANCH_NAME not found in Neon"
            echo "Available branches:"
            echo "$RESPONSE" | jq -r '.branches[].name'
            exit 1
          fi

          echo "DATABASE_URL=$DB_URL" >> $GITHUB_OUTPUT
          echo "âœ… Found database URL for branch: $NEON_BRANCH_NAME"
      - name: Run Migrations on Preview Branch
        run: |
          bun install
          bunx turbo migrate
        env:
          DATABASE_URL: "${{ steps.get_neon_branch.outputs.DATABASE_URL }}"

  delete_preview_branch:
    name: Delete Preview Neon Branch
    uses: ./.github/workflows/neon-delete-branch.yml
    needs: setup
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    with:
      branch_name: "${{ needs.setup.outputs.neon_branch_name }}"
    secrets: inherit
